# ğŸ“§ Guia Completo - Sistema de Templates de Email SAOS

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Estrutura da Tabela TEMPLATES_EMAIL](#estrutura-da-tabela-templates_email)
4. [Tipos de Templates](#tipos-de-templates)
5. [VariÃ¡veis DisponÃ­veis](#variÃ¡veis-disponÃ­veis)
6. [Como Usar](#como-usar)
7. [Interface Administrativa](#interface-administrativa)
8. [Exemplos PrÃ¡ticos](#exemplos-prÃ¡ticos)
9. [ConfiguraÃ§Ã£o](#configuraÃ§Ã£o)
10. [Troubleshooting](#troubleshooting)

## ğŸ¯ VisÃ£o Geral

O Sistema de Templates de Email do SAOS permite criar, gerenciar e usar templates de email personalizados para diferentes cenÃ¡rios do sistema. Os templates suportam variÃ¡veis dinÃ¢micas que sÃ£o substituÃ­das automaticamente com dados especÃ­ficos de cada situaÃ§Ã£o.

### **Principais BenefÃ­cios:**

- âœ… **PadronizaÃ§Ã£o**: Emails consistentes com a identidade visual
- âœ… **AutomaÃ§Ã£o**: Envio automÃ¡tico baseado em eventos do sistema
- âœ… **PersonalizaÃ§Ã£o**: VariÃ¡veis dinÃ¢micas para conteÃºdo contextual
- âœ… **Flexibilidade**: Templates HTML e texto plano
- âœ… **Gerenciamento**: Interface administrativa completa

## ğŸ—ï¸ Arquitetura do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚   API Routes     â”‚    â”‚   Database      â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ - Admin Panel   â”‚â—„â”€â”€â–ºâ”‚ - CRUD Templates â”‚â—„â”€â”€â–ºâ”‚ - TEMPLATES_EMAILâ”‚
â”‚ - Template Mgmt â”‚    â”‚ - Email Testing  â”‚    â”‚ - CONFIGURACOES â”‚
â”‚ - Preview       â”‚    â”‚ - Validation     â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Email Service  â”‚
                       â”‚                  â”‚
                       â”‚ - SMTP Config    â”‚
                       â”‚ - Template Engineâ”‚
                       â”‚ - Variable Sub   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Componentes Principais:**

1. **EmailTemplateManager**: Gerenciador principal de templates
2. **EmailService**: ServiÃ§o de envio de emails
3. **API Routes**: Endpoints para CRUD de templates
4. **Admin Interface**: Interface web para gerenciamento
5. **Database**: Armazenamento de templates e configuraÃ§Ãµes

## ğŸ“Š Estrutura da Tabela TEMPLATES_EMAIL

```sql
CREATE TABLE TEMPLATES_EMAIL (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR(100) NOT NULL,                    -- Nome Ãºnico do template
    ASSUNTO VARCHAR(200) NOT NULL,                 -- Assunto do email
    CORPO_HTML BLOB NOT NULL,                      -- ConteÃºdo HTML
    CORPO_TEXTO BLOB,                              -- ConteÃºdo texto plano (opcional)
    VARIAVEIS BLOB,                                -- JSON com variÃ¡veis disponÃ­veis
    ATIVO BOOLEAN DEFAULT TRUE,                    -- Status do template
    DTHR_CRIACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DTHR_ATUALIZACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **Campos Detalhados:**

- **NOME**: Identificador Ãºnico do template (ex: `confirmacao_abertura`)
- **ASSUNTO**: Assunto do email com suporte a variÃ¡veis
- **CORPO_HTML**: ConteÃºdo HTML completo do email
- **CORPO_TEXTO**: VersÃ£o texto plano (para clientes que nÃ£o suportam HTML)
- **VARIAVEIS**: Array JSON com nomes das variÃ¡veis disponÃ­veis
- **ATIVO**: Controla se o template estÃ¡ disponÃ­vel para uso

## ğŸ“§ Tipos de Templates

### **1. ConfirmaÃ§Ã£o de Abertura**
- **Nome**: `confirmacao_abertura`
- **Uso**: Enviado quando uma nova solicitaÃ§Ã£o Ã© criada
- **DestinatÃ¡rio**: Cliente
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `titulo`, `categoria`, `prioridade`, `prazo_estimado`, `descricao`, `link_acompanhamento`

### **2. AtualizaÃ§Ã£o de Status**
- **Nome**: `atualizacao_status`
- **Uso**: Enviado quando o status da solicitaÃ§Ã£o Ã© alterado
- **DestinatÃ¡rio**: Cliente
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `novo_status`, `cor_status`, `responsavel`, `data_atualizacao`, `comentario`, `link_acompanhamento`

### **3. SolicitaÃ§Ã£o de InformaÃ§Ãµes**
- **Nome**: `solicitacao_informacoes`
- **Uso**: Enviado quando o tÃ©cnico precisa de informaÃ§Ãµes adicionais
- **DestinatÃ¡rio**: Cliente
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `titulo`, `responsavel`, `informacoes_necessarias`, `link_atualizacao`

### **4. ResoluÃ§Ã£o ConcluÃ­da**
- **Nome**: `resolucao_concluida`
- **Uso**: Enviado quando a solicitaÃ§Ã£o Ã© resolvida
- **DestinatÃ¡rio**: Cliente
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `titulo`, `solucao`, `responsavel`, `data_resolucao`, `tempo_resolucao`, `link_avaliacao`

### **5. Lembrete de Prazo**
- **Nome**: `lembrete_prazo`
- **Uso**: Enviado quando o prazo estÃ¡ prÃ³ximo de expirar
- **DestinatÃ¡rio**: Cliente/TÃ©cnico
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `titulo`, `prazo_limite`, `tempo_restante`, `responsavel`, `link_acompanhamento`

### **6. EscalaÃ§Ã£o para TÃ©cnico**
- **Nome**: `escalacao_tecnico`
- **Uso**: Enviado quando uma solicitaÃ§Ã£o Ã© atribuÃ­da a um tÃ©cnico
- **DestinatÃ¡rio**: TÃ©cnico
- **VariÃ¡veis**: `codigo_referencia`, `nome_cliente`, `titulo`, `categoria`, `prioridade`, `descricao`, `prazo_limite`, `link_solicitacao`

## ğŸ”§ VariÃ¡veis DisponÃ­veis

### **VariÃ¡veis de SolicitaÃ§Ã£o:**
- `{codigo_referencia}` - CÃ³digo Ãºnico da solicitaÃ§Ã£o
- `{titulo}` - TÃ­tulo da solicitaÃ§Ã£o
- `{descricao}` - DescriÃ§Ã£o detalhada
- `{categoria}` - Nome da categoria
- `{prioridade}` - Nome da prioridade
- `{prazo_estimado}` - Prazo estimado formatado
- `{prazo_limite}` - Prazo limite formatado

### **VariÃ¡veis de UsuÃ¡rio:**
- `{nome_cliente}` - Nome do cliente
- `{email_cliente}` - Email do cliente
- `{responsavel}` - Nome do tÃ©cnico responsÃ¡vel
- `{tecnico_email}` - Email do tÃ©cnico

### **VariÃ¡veis de Status:**
- `{novo_status}` - Nome do novo status
- `{cor_status}` - Cor do status (para HTML)
- `{data_atualizacao}` - Data/hora da atualizaÃ§Ã£o

### **VariÃ¡veis de Sistema:**
- `{link_acompanhamento}` - Link para acompanhar a solicitaÃ§Ã£o
- `{link_atualizacao}` - Link para atualizar a solicitaÃ§Ã£o
- `{link_avaliacao}` - Link para avaliar o serviÃ§o
- `{link_solicitacao}` - Link direto para a solicitaÃ§Ã£o
- `{link_dashboard}` - Link para o dashboard

### **VariÃ¡veis de Tempo:**
- `{data_resolucao}` - Data/hora da resoluÃ§Ã£o
- `{tempo_resolucao}` - Tempo total de resoluÃ§Ã£o
- `{tempo_restante}` - Tempo restante atÃ© o prazo

### **VariÃ¡veis Customizadas:**
- `{comentario}` - ComentÃ¡rio adicional
- `{solucao}` - SoluÃ§Ã£o aplicada
- `{informacoes_necessarias}` - InformaÃ§Ãµes solicitadas

## ğŸš€ Como Usar

### **1. Uso BÃ¡sico**

```python
from utils.email_template_manager import EmailTemplateManager

# Inicializar o gerenciador
template_manager = EmailTemplateManager()

# Preparar variÃ¡veis
variaveis = {
    'codigo_referencia': 'OS-2024-001',
    'nome_cliente': 'JoÃ£o Silva',
    'titulo': 'Problema de Login',
    'categoria': 'Acesso',
    'prioridade': 'Alta'
}

# Enviar email
sucesso = template_manager.enviar_email_com_template(
    nome_template='confirmacao_abertura',
    destinatario='cliente@exemplo.com',
    variaveis=variaveis
)
```

### **2. Uso AvanÃ§ado com ValidaÃ§Ã£o**

```python
# Validar template antes de usar
dados_template = {
    'nome': 'meu_template',
    'assunto': 'Teste {variavel}',
    'corpo_html': '<p>OlÃ¡ {nome}</p>',
    'variaveis': ['variavel', 'nome']
}

validacao = template_manager.validar_template(dados_template)
if validacao['valido']:
    print("Template vÃ¡lido!")
    print(f"VariÃ¡veis encontradas: {validacao['variaveis_encontradas']}")
else:
    print(f"Erros: {validacao['erros']}")
```

### **3. IntegraÃ§Ã£o no Sistema**

```python
# Em routes/formulario.py - apÃ³s criar solicitaÃ§Ã£o
def enviar_confirmacao_abertura(solicitacao_id):
    template_manager = EmailTemplateManager()
    
    # Buscar dados da solicitaÃ§Ã£o
    solicitacao = get_solicitacao_completa(solicitacao_id)
    
    # Preparar variÃ¡veis
    variaveis = {
        'codigo_referencia': solicitacao['CODIGO_REFERENCIA'],
        'nome_cliente': solicitacao['NOME_CLIENTE'],
        'titulo': solicitacao['TITULO'],
        'categoria': solicitacao['NOME_CATEGORIA'],
        'prioridade': solicitacao['NOME_PRIORIDADE'],
        'prazo_estimado': formatar_prazo(solicitacao['PRAZO_RESOLUCAO']),
        'descricao': solicitacao['DESCRICAO'],
        'link_acompanhamento': f"{BASE_URL}/acompanhar/{solicitacao['CODIGO_REFERENCIA']}"
    }
    
    # Enviar email
    return template_manager.enviar_email_com_template(
        nome_template='confirmacao_abertura',
        destinatario=solicitacao['EMAIL_CLIENTE'],
        variaveis=variaveis
    )
```

## ğŸ–¥ï¸ Interface Administrativa

### **Acessando a Interface:**

1. FaÃ§a login como administrador
2. Acesse o painel administrativo
3. Clique no card "Templates"
4. VocÃª serÃ¡ redirecionado para `/admin/templates`

### **Funcionalidades DisponÃ­veis:**

#### **ğŸ“Š Dashboard de Templates**
- EstatÃ­sticas de templates (total, ativos, inativos)
- Contador de emails enviados
- Filtros por status

#### **ğŸ“ Gerenciamento de Templates**
- **Criar**: Novo template com editor HTML
- **Editar**: Modificar templates existentes
- **Visualizar**: Preview do template
- **Testar**: Enviar email de teste
- **Ativar/Desativar**: Controle de status
- **Excluir**: Soft delete de templates

#### **ğŸ”§ Editor AvanÃ§ado**
- **CodeMirror**: Editor com syntax highlighting
- **DetecÃ§Ã£o AutomÃ¡tica**: VariÃ¡veis detectadas automaticamente
- **ValidaÃ§Ã£o**: VerificaÃ§Ã£o de variÃ¡veis
- **Preview**: VisualizaÃ§Ã£o em tempo real

### **Como Criar um Template:**

1. **Clique em "Novo Template"**
2. **Preencha os campos bÃ¡sicos:**
   - Nome: Identificador Ãºnico
   - Assunto: Assunto do email
3. **Escreva o conteÃºdo HTML:**
   - Use variÃ¡veis no formato `{variavel}`
   - O editor detecta automaticamente as variÃ¡veis
4. **Adicione conteÃºdo texto (opcional):**
   - VersÃ£o texto plano para compatibilidade
5. **Configure as variÃ¡veis:**
   - As variÃ¡veis sÃ£o detectadas automaticamente
   - VocÃª pode adicionar variÃ¡veis manualmente
6. **Salve o template**

### **Como Testar um Template:**

1. **Clique no Ã­cone de teste (ğŸ“§)**
2. **Digite o email de destino**
3. **Preencha as variÃ¡veis de teste**
4. **Clique em "Enviar Email de Teste"**
5. **Verifique se o email foi recebido**

## ğŸ’¡ Exemplos PrÃ¡ticos

### **Exemplo 1: Template de ConfirmaÃ§Ã£o**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ConfirmaÃ§Ã£o de SolicitaÃ§Ã£o</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="background: #3B82F6; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
            <h1 style="margin: 0;">SAOS - Sistema de Abertura de OS</h1>
        </div>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 0 0 8px 8px;">
            <h2 style="color: #3B82F6;">SolicitaÃ§Ã£o Registrada com Sucesso!</h2>
            
            <p>OlÃ¡ <strong>{nome_cliente}</strong>,</p>
            
            <p>Sua solicitaÃ§Ã£o foi registrada em nosso sistema com sucesso. Abaixo estÃ£o os detalhes:</p>
            
            <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p><strong>CÃ³digo:</strong> {codigo_referencia}</p>
                <p><strong>TÃ­tulo:</strong> {titulo}</p>
                <p><strong>Categoria:</strong> {categoria}</p>
                <p><strong>Prioridade:</strong> <span style="color: #EF4444;">{prioridade}</span></p>
                <p><strong>Prazo Estimado:</strong> {prazo_estimado}</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <a href="{link_acompanhamento}" style="background: #3B82F6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">
                    Acompanhar SolicitaÃ§Ã£o
                </a>
            </div>
        </div>
    </div>
</body>
</html>
```

### **Exemplo 2: Template de AtualizaÃ§Ã£o**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AtualizaÃ§Ã£o de Status</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="background: {cor_status}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
            <h1 style="margin: 0;">Status Atualizado</h1>
        </div>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 0 0 8px 8px;">
            <h2 style="color: {cor_status};">Sua solicitaÃ§Ã£o foi atualizada</h2>
            
            <p>OlÃ¡ <strong>{nome_cliente}</strong>,</p>
            
            <p>A solicitaÃ§Ã£o <strong>{codigo_referencia}</strong> teve seu status alterado para:</p>
            
            <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0; text-align: center;">
                <h3 style="color: {cor_status}; margin: 0;">{novo_status}</h3>
                <p style="margin: 5px 0 0 0; font-size: 14px;">Atualizado em {data_atualizacao}</p>
            </div>
            
            <p><strong>ResponsÃ¡vel:</strong> {responsavel}</p>
            
            {comentario}
            
            <div style="text-align: center; margin: 30px 0;">
                <a href="{link_acompanhamento}" style="background: {cor_status}; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">
                    Ver Detalhes
                </a>
            </div>
        </div>
    </div>
</body>
</html>
```

## âš™ï¸ ConfiguraÃ§Ã£o

### **1. ConfiguraÃ§Ãµes de Email**

As configuraÃ§Ãµes de email sÃ£o armazenadas na tabela `CONFIGURACOES`:

```sql
-- ConfiguraÃ§Ãµes SMTP
INSERT INTO CONFIGURACOES (CHAVE, VALOR, DESCRICAO) VALUES
('EMAIL_SMTP_HOST', 'smtp.office365.com', 'Servidor SMTP'),
('EMAIL_SMTP_PORT', '587', 'Porta SMTP'),
('EMAIL_SMTP_USER', 'suporte@empresa.com.br', 'UsuÃ¡rio SMTP'),
('EMAIL_SMTP_PASS', 'sua_senha', 'Senha SMTP'),
('EMAIL_FROM', 'suporte@empresa.com.br', 'Email remetente'),
('SISTEMA_NOME', 'SAOS - Sistema de Abertura de OS', 'Nome do sistema'),
('SISTEMA_URL', 'http://localhost:5001', 'URL base do sistema');
```

### **2. ConfiguraÃ§Ãµes de SeguranÃ§a**

```python
# Em utils/email_service.py
class EmailService:
    def __init__(self):
        self.config = self._load_config()
    
    def _load_config(self):
        """Carrega configuraÃ§Ãµes de email do banco"""
        with db_connection() as con:
            cur = con.cursor()
            cur.execute("SELECT CHAVE, VALOR FROM CONFIGURACOES WHERE CHAVE LIKE 'EMAIL_%'")
            config = dict(cur.fetchall())
        
        return {
            'smtp_host': config.get('EMAIL_SMTP_HOST', 'smtp.office365.com'),
            'smtp_port': int(config.get('EMAIL_SMTP_PORT', '587')),
            'smtp_user': config.get('EMAIL_SMTP_USER', ''),
            'smtp_pass': config.get('EMAIL_SMTP_PASS', ''),
            'from_email': config.get('EMAIL_FROM', ''),
            'from_name': config.get('SISTEMA_NOME', 'SAOS')
        }
```

### **3. ConfiguraÃ§Ãµes de Template**

```python
# ConfiguraÃ§Ãµes padrÃ£o para novos templates
TEMPLATE_DEFAULTS = {
    'confirmacao_abertura': {
        'nome': 'confirmacao_abertura',
        'assunto': 'Sua solicitaÃ§Ã£o #{codigo_referencia} foi registrada com sucesso',
        'variaveis': ['codigo_referencia', 'nome_cliente', 'titulo', 'categoria', 'prioridade', 'prazo_estimado', 'descricao', 'link_acompanhamento']
    },
    'atualizacao_status': {
        'nome': 'atualizacao_status',
        'assunto': 'AtualizaÃ§Ã£o da solicitaÃ§Ã£o #{codigo_referencia}',
        'variaveis': ['codigo_referencia', 'nome_cliente', 'novo_status', 'cor_status', 'responsavel', 'data_atualizacao', 'comentario', 'link_acompanhamento']
    }
}
```

## ğŸ”§ Troubleshooting

### **Problemas Comuns e SoluÃ§Ãµes:**

#### **1. Email nÃ£o Ã© enviado**
```
Erro: SMTP Authentication failed
SoluÃ§Ã£o: Verificar credenciais SMTP na tabela CONFIGURACOES
```

#### **2. VariÃ¡veis nÃ£o sÃ£o substituÃ­das**
```
Erro: {variavel} aparece no email
SoluÃ§Ã£o: Verificar se a variÃ¡vel estÃ¡ definida no dicionÃ¡rio variaveis
```

#### **3. Template nÃ£o encontrado**
```
Erro: Template 'nome_template' nÃ£o encontrado
SoluÃ§Ã£o: Verificar se o template existe e estÃ¡ ativo
```

#### **4. Caracteres especiais corrompidos**
```
Erro: Acentos aparecem como ?????
SoluÃ§Ã£o: Verificar encoding UTF-8 no template e configuraÃ§Ãµes
```

#### **5. HTML nÃ£o renderiza**
```
Erro: Email aparece como cÃ³digo HTML
SoluÃ§Ã£o: Verificar se o cliente de email suporta HTML
```

### **Logs de Debug:**

```python
# Habilitar logs detalhados
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger('email_service')

# No EmailService
def enviar_email(self, destinatario, assunto, corpo_html, corpo_texto=None):
    try:
        logger.debug(f"Enviando email para: {destinatario}")
        logger.debug(f"Assunto: {assunto}")
        # ... resto do cÃ³digo
    except Exception as e:
        logger.error(f"Erro ao enviar email: {e}")
        return False
```

### **Testes de Conectividade:**

```python
# Testar conexÃ£o SMTP
def testar_conexao_smtp():
    import smtplib
    
    try:
        with smtplib.SMTP('smtp.office365.com', 587) as server:
            server.starttls()
            server.login('seu_email@empresa.com', 'sua_senha')
            print("âœ… ConexÃ£o SMTP OK")
            return True
    except Exception as e:
        print(f"âŒ Erro na conexÃ£o SMTP: {e}")
        return False
```

## ğŸ“š Recursos Adicionais

### **Links Ãšteis:**
- [DocumentaÃ§Ã£o do Sistema SAOS](../README.md)
- [API Reference](../docs/api_reference.md)
- [Database Schema](../database/schema.sql)

### **Exemplos de CÃ³digo:**
- [Exemplos de Uso](../examples/email_templates_usage.py)
- [Templates PadrÃ£o](../utils/email_template_manager.py)

### **Ferramentas:**
- [Interface Administrativa](../templates/admin_templates.html)
- [Gerenciador de Templates](../utils/email_template_manager.py)
- [ServiÃ§o de Email](../utils/email_service.py)

---

**ğŸ“ Suporte:** Para dÃºvidas ou problemas, consulte a documentaÃ§Ã£o ou entre em contato com a equipe de desenvolvimento.
